# File Storage Configuration Feature

## Goal Description

Implement a flexible storage configuration feature using [Flydrive](https://flydrive.dev/) (v2) to allow the application to write data to different storage backends (initially Filesystem and S3).
This involves creating a new `StorageManagerService` that wraps Flydrive, and a `StandardDatastreamService` that uses this service to manage file attachments, moving them from a staging location to a permanent storage location.

## User Review Required

> [!IMPORTANT]
> This change introduces `flydrive` (v2) and its drivers.
> `DatastreamService` will now require configuration for both `staging` and `primary` storage disks.

## Proposed Changes

### Dependencies

- Add `flydrive` (v2) to `packages/redbox-core-types`.
- Add `@flydrive/drivers-s3` (or equivalent for v2) if S3 support is needed immediately, otherwise ensure flexible driver registration.

### Packages

#### [packages/redbox-core-types]

##### [NEW] [StorageManagerService.ts](packages/redbox-core-types/src/services/StorageManagerService.ts)

- Wrapper around Flydrive `StorageManager`.
- Configures generic disks based on `storage.config.ts`.
- Exposes access to specific disks (e.g., `staging`, `primary`).

##### [NEW] [StandardDatastreamService.ts](packages/redbox-core-types/src/services/StandardDatastreamService.ts)

- Implements `DatastreamService` interface.
- **`addDatastreams` Logic**:
  1.  Receives file information (fileId/path) which is currently in the `staging` area (uploaded by `RecordController`).
  2.  Uses `StorageManagerService` to get the `staging` disk.
  3.  Verifies file existence in `staging`.
  4.  Uses `StorageManagerService` to get the `primary` disk.
  5.  Moves (or streams and deletes) the file from `staging` to `primary`.
  6.  Returns updated metadata pointing to the `primary` storage location.
- **`getDatastream` Logic**:
  1.  Uses `StorageManagerService` to get the `primary` disk.
  2.  Returns a stream/buffer of the file.

##### [MODIFY] [config/storage.config.ts](packages/redbox-core-types/src/config/storage.config.ts)

- Update `StorageConfig` to support multiple disks.
- Define `disks` map allowing arbitrary driver configuration.

```typescript
interface FSDriverOptions {
  root: string;
}

interface S3DriverOptions {
  key: string;
  secret: string;
  bucket: string;
  region: string;
  endpoint?: string;
  [key: string]: any;
}

export type DiskConfig = { driver: 'fs'; config: FSDriverOptions } | { driver: 's3'; config: S3DriverOptions };

export interface StorageConfig {
  defaultDisk: string;
  stagingDisk: string;
  primaryDisk: string;
  disks: {
    [key: string]: DiskConfig;
  };
}
```

> [!NOTE]
> `FigshareService` currently manages its own file uploads from a temp directory.
> The new `StorageManagerService` will handle the primary storage config, but `FigshareService` logic for reading from staging (which it expects to be local FS) should be preserved or updated to use `StorageManagerService.disk('staging')` if possible, or ensured to alignment with `RecordController`'s upload location.

##### [MODIFY] [index.ts](packages/redbox-core-types/src/index.ts)

- Export `StorageManagerService` and `StandardDatastreamService`.

### API (Sails App)

- _Note: API Shims (`api/services/_.js`) are auto-generated by `redbox-loader.js` and do not need to be created manually.\*

#### [MODIFY] [config/storage.js](config/storage.js)

- Update default configuration to include `staging` (fs) and `primary` (fs) disks.

## Verification Plan

### Automated Tests

- **StorageManagerService**: Unit tests in `packages/redbox-core-types/test/services/StorageManagerService.test.ts`.
- **StandardDatastreamService**: Unit tests in `packages/redbox-core-types/test/services/StandardDatastreamService.test.ts`, mocking Flydrive to verify move logic.

### Manual Verification

1.  **Setup**:
    - Configure `storage.js` with `staging` pointing to `/tmp/staging` and `primary` pointing to `/tmp/primary`.
2.  **Execution**:
    - Upload a file to a record via the UI/API.
    - `RecordController` saves to `/tmp/staging`.
    - `StandardDatastreamService` is called.
3.  **Verification**:
    - Verify file exists in `/tmp/primary`.
    - Verify file is removed from `/tmp/staging` (if move logic implemented).
    - Download file via API config to ensure `getDatastream` works from `primary`.
