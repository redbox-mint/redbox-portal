# Vocabulary API Modernisation

## Planning
- [ ] Research existing codebase
- [ ] Read relevant skills (design-planner, controllers, services, form-config, testing)
- [ ] Write full design document (following redbox-feature-design-planner template)
- [ ] Get user approval on design

## Execution (pending design approval)
- [ ] Add `getByIdOrSlug(branding, idOrSlug)` and `getEntries(branding, vocabIdOrSlug, options)` to `VocabularyService`
- [ ] Write service unit tests
- [ ] Implement `get`, `entries`, and `getRecords` actions in `FormVocabularyController`
- [ ] Scaffold `FormVocabularyController` via `redbox-hook-kit` (shim auto-generated by redbox-loader; index handled by generator)
- [ ] Update `routes.config.ts` and `auth.config.ts`
- [ ] Move `get /:branding/:portal/query/vocab/:queryId` to `FormVocabularyController.getRecords`
- [ ] Add auth rules for `/:branding/:portal/query/vocab(/*)` for Researcher, Librarians, Admin
- [ ] Write controller unit tests
- [ ] Add controller/API tests for response contracts (`200/400/404/500` and stable error codes)
- [ ] Code review (redbox-feature-implementation-review)
- [ ] Create Bruno integration tests
- [ ] Add Bruno assertions for API error-code contract
- [ ] Add `vocabRef`/`inlineVocab` to component configs
- [ ] Create `VocabInlineFormConfigVisitor`
- [ ] Make `FormsService.buildClientFormConfig()` async + integrate visitor
- [ ] Update explicit async call sites (`RecordController.renderInternal`, `FormRecordConsistencyService.mergeRecord`, `FormRecordConsistencyService.extractRawTemplates`)
- [ ] Audit and update downstream callers for async changes
- [ ] Write visitor unit tests
- [ ] Deprecate all `VocabService` (including `bootstrap`) and `VocabController` methods
- [ ] Final integration test run
- [ ] Post-rollout observability check (24-48h): monitor `/vocab/*` and `/query/vocab/*` 404/5xx and triage regressions
