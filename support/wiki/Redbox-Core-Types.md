# Redbox Core Types Package

The `@researchdatabox/redbox-core-types` package provides shared TypeScript type definitions and core business logic used across the ReDBox Portal system.

## Overview

This package centralizes:
- **Type definitions** for models, services, and configuration
- **Business logic services** - All core services for records, workflows, users, etc.
- **Controllers** for API and webservice request handling
- **Waterline model definitions** for database entities
- **Policy functions** for authorization and request handling
- **Configuration defaults** for all Sails.js config keys
- **Core bootstrap logic** for application startup

## Package Structure

| Directory | Description |
|---|---|
| `src/services/` | Core business logic services - records, workflows, users, email, etc. |
| `src/controllers/` | API controllers for portal routes |
| `src/controllers/webservice/` | Webservice controllers for API routes |
| `src/config/` | Configuration defaults for all sails.config keys (65+ config modules) |
| `src/configmodels/` | Configuration models for menus, panels, sidebars, system messages |
| `src/policies/` | Authorization policies (isAuthenticated, checkAuth, etc.) |
| `src/waterline-models/` | Waterline ORM model definitions (User, Role, RecordType, etc.) |
| `src/model/` | TypeScript interfaces and business models |
| `src/decorators/` | TypeScript decorators for controllers and services |
| `src/responses/` | Custom Sails.js response handlers |
| `src/middleware/` | Express middleware functions |

## Key Exports

```typescript
import {
    // Base classes for controllers and services
    Controllers,
    Services,

    // Controller exports for shim generation
    ControllerExports,
    WebserviceControllerExports,
    ControllerNames,
    WebserviceControllerNames,

    // Policy functions
    Policies,

    // Waterline model definitions
    WaterlineModels,

    // Service exports for shim generation
    ServiceExports,

    // Configuration defaults
    Config,

    // Bootstrap functions
    coreBootstrap,
    preLiftSetup,
    BootstrapProvider,

    // Hooks
    defineWebpackHook,

    // Shims
    momentShim
} from '@researchdatabox/redbox-core-types';
```

## Controllers

Controllers are defined in `src/controllers/` (API) and `src/controllers/webservice/` (webservice). Shims are generated by the [Redbox Loader](Redbox-Loader) to expose these controllers to Sails.js.

Controller exports are lazy-instantiated through `ControllerExports` and `WebserviceControllerExports`. Name lists (`ControllerNames`, `WebserviceControllerNames`) allow shim generation without instantiating controllers.

See [Controllers Architecture](Controllers-Architecture) for controller lifecycle, `init()` usage, and hook overrides.

## Core Services

All core ReDBox business logic services are defined in `src/services/`. These services handle records, workflows, users, email, integrations, and more.

### Service Architecture

Services extend the `Services.Core.Service` base class and follow a consistent pattern:

```typescript
import { Services as services } from '../CoreService';

export module Services {
    export class MyService extends services.Core.Service {
        // Methods to export to Sails.js
        protected _exportedMethods: any = [
            'bootstrap',
            'myMethod',
            'anotherMethod'
        ];

        public async bootstrap() {
            // Initialization logic
        }

        public myMethod(param: string): Observable<any> {
            // Business logic
        }
    }
}
```

### Service Categories

| Category | Services | Description |
|---|---|---|
| **Records & Data** | `RecordsService`, `RecordTypesService`, `FormsService`, `FormRecordConsistencyService` | Record CRUD, metadata, form handling |
| **Workflows** | `WorkflowStepsService`, `TriggerService` | Workflow transitions and triggers |
| **Users & Auth** | `UsersService`, `RolesService` | User management and authorization |
| **Search & Cache** | `SolrSearchService`, `CacheService`, `NamedQueryService` | Search indexing and caching |
| **Integrations** | `OrcidService`, `DoiService`, `FigshareService`, `RaidService`, `OniService` | External API integrations |
| **Workspaces** | `WorkspaceService`, `WorkspaceTypesService`, `WorkspaceAsyncService` | Research workspace management |
| **Email & Notifications** | `EmailService` | Email delivery |
| **Configuration** | `ConfigService`, `AppConfigService`, `BrandingService`, `BrandingLogoService` | Runtime configuration |
| **Templates & I18n** | `TemplateService`, `TranslationService`, `I18nEntriesService` | Templating and internationalization |
| **Reports** | `ReportsService`, `DashboardTypesService` | Reporting and dashboards |
| **Utilities** | `ViewUtilsService`, `PathRulesService`, `DomSanitizerService`, `ContrastService`, `SassCompilerService` | Helper utilities |
| **Background Jobs** | `AgendaQueueService`, `AsynchsService` | Job queue and async processing |
| **Navigation** | `NavigationService` | Menu and navigation |
| **Vocabularies** | `VocabService` | Controlled vocabularies |
| **Data Plans** | `RDMPService` | Research Data Management Plans |

### ServiceExports Object

The `ServiceExports` object provides lazy-instantiated services for the [Redbox Loader](Redbox-Loader) to generate shims:

```typescript
import { ServiceExports } from '@researchdatabox/redbox-core-types';

// Access a service (lazy instantiation)
const recordsService = ServiceExports['RecordsService'];
```

Services are instantiated via `new ServiceClass().exports()` which provides method binding and filtering appropriate for Sails.js services.

### Service List

| Service | Description |
|---|---|
| `AgendaQueueService` | Background job queue using Agenda |
| `AppConfigService` | Application-level configuration |
| `AsynchsService` | Asynchronous operation handling |
| `BrandingLogoService` | Brand logo management |
| `BrandingService` | Multi-tenancy branding |
| `CacheService` | In-memory and database caching |
| `ConfigService` | Runtime configuration access |
| `ContrastService` | Color contrast calculations |
| `DashboardTypesService` | Dashboard type definitions |
| `DoiService` | DataCite DOI registration |
| `EmailService` | Email delivery via nodemailer |
| `FigshareService` | Figshare repository integration |
| `FormRecordConsistencyService` | Form-record validation |
| `FormsService` | Dynamic form management |
| `I18nEntriesService` | Translation entry management |
| `NamedQueryService` | Saved query execution |
| `NavigationService` | Menu and navigation building |
| `OniService` | Oni (OCFL) integration |
| `OrcidService` | ORCID integration |
| `PathRulesService` | URL path rule resolution |
| `RaidService` | RAiD identifier integration |
| `RDMPService` | Research Data Management Plans |
| `RecordsService` | Core record operations |
| `RecordTypesService` | Record type configuration |
| `ReportsService` | Report generation |
| `RolesService` | User role management |
| `SassCompilerService` | SASS/SCSS compilation |
| `SolrSearchService` | Solr search integration |
| `DomSanitizerService` | SVG sanitization |
| `TemplateService` | EJS template rendering |
| `TranslationService` | Multi-language support |
| `TriggerService` | Workflow trigger execution |
| `UsersService` | User account management |
| `ViewUtilsService` | View helper utilities |
| `VocabService` | Vocabulary/controlled list lookups |
| `WorkflowStepsService` | Workflow step management |
| `WorkspaceAsyncService` | Async workspace operations |
| `WorkspaceService` | Workspace management |
| `WorkspaceTypesService` | Workspace type definitions |

## Configuration System

All ReDBox configuration defaults are defined in `src/config/` modules. Each module exports:
1. A **TypeScript interface** defining the config shape
2. A **default value** for that configuration

Example from `appmode.config.ts`:

```typescript
export interface AppModeConfig {
    bootstrapAlways: boolean;
    bootstrapOnce?: boolean;
}

export const appmode: AppModeConfig = {
    bootstrapAlways: true
};
```

The [Redbox Loader](Redbox-Loader) uses these defaults to generate config shim files.

## Waterline Models

Database models are defined in `src/waterline-models/`:

| Model | Description |
|---|---|
| `User` | User accounts and authentication data |
| `Role` | User roles and permissions |
| `RecordType` | Research data record type definitions |
| `WorkflowStep` | Workflow state transitions |
| `Form` | Dynamic form configurations |
| `BrandingConfig` | Portal branding settings |
| `Report` | Report definitions |
| `NamedQuery` | Saved query configurations |

## Policies

Authorization policies in `src/policies/`:

| Policy | Description |
|---|---|
| `isAuthenticated` | Verifies user is logged in |
| `checkAuth` | Validates authorization for actions |
| `checkBrandingValid` | Ensures branding context is valid |
| `contentSecurityPolicy` | Applies CSP headers |
| `menuResolver` | Resolves navigation menus |
| `i18nLanguages` | Sets up internationalization |

## Bootstrap Functions

The package exports bootstrap functions called during Sails.js startup:

```typescript
// Core bootstrap - initializes all ReDBox services
export async function coreBootstrap(): Promise<void>;

// Pre-lift setup - configuration adjustments before services bootstrap
export function preLiftSetup(): void;
```

The generated `config/bootstrap.js` shim calls these functions in order.

## Webpack Hook

The package provides a custom Sails.js hook for compiling assets using Webpack:

```typescript
// Define the hook in a Sails app
import { defineWebpackHook } from '@researchdatabox/redbox-core-types';

export default function(sails) {
    return defineWebpackHook(sails);
}
```

This hook:
- Compiles assets in `production` (Docker) environments.
- Supports `WEBPACK_SKIP=true` to bypass compilation.
- Supports `WEBPACK_CSS_MINI=true` for CSS minimization.

## Shims

Helper functions for backward compatibility are available in `src/shims/`:

- **momentShim**: A Luxon-based shim that replicates Moment.js formatting for templates.

```typescript
import { momentShim } from '@researchdatabox/redbox-core-types';
const formattedDate = momentShim(new Date()).format('YYYY-MM-DD');
```

## Usage in Hooks

Hooks extending ReDBox can depend on this package:

```json
{
    "dependencies": {
        "@researchdatabox/redbox-core-types": "^1.5.0"
    }
}
```

See also:
- [Redbox Loader](Redbox-Loader) - Pre-lift shim generation
- [Redbox Hook Kit](Redbox-Hook-Kit) - Hook development toolkit
- [Using a Sails Hook to customise ReDBox](Using-a-Sails-Hook-to-customise-ReDBox)
