# Architecture Overview

## High-Level Structure

RedBox Portal is a hybrid application combining a **Sails.js** (Node.js) backend with an **Angular** frontend. It is designed to assist researchers and institutions in planning, creating, and publishing research data assets.

### Core Technologies

- **Backend**: [Sails.js](https://sailsjs.com/) (v1.5) framework.
- **Frontend**: Angular (bundled via Webpack).
- **Database**: MongoDB (via `sails-mongo`).
- **Language**: TypeScript (Backend and Frontend).
- **Package Management**: npm with local packages in `packages/`.
- **Infrastructure**: Docker and Docker Compose for development and testing.

## Directory Structure

| Directory | Description |
|---|---|
| `api/` | Sails.js API definitions (Controllers, Models, Policies, Services) - **generated by redbox-loader**. |
| `config/` | Sails.js configuration files - **shims generated by redbox-loader, environment overrides added manually**. |
| `angular/` | Angular frontend application source code. |
| `packages/` | Local npm packages used by the application (e.g., `redbox-core-types`, `sails-ng-common`). |
| `typescript/` | Backend TypeScript source code. |
| `support/` | Supporting scripts, documentation, and test configurations. |
| `test/` | Frontend and specific package tests. Backend tests seem to be in `support/integration-testing` or `typescript/test`. |
| `views/` | Server-side view templates (EJS). |

## Key Packages (`packages/`)

The application is modularized using local packages to share code between the backend and frontend, and to isolate specific functionality.

| Package | Name | Description |
|---|---|---|
| `redbox-core-types` | `@researchdatabox/redbox-core-types` | Shared TypeScript type definitions, core business logic services, Waterline models, policies, config defaults, and bootstrap functions. See [Redbox Core Types](Redbox-Core-Types). |
| `sails-ng-common` | `@researchdatabox/sails-ng-common` | Common models and logic shared explicitly between the Sails.js API and the Angular frontend. |
| `raido` | `@researchdatabox/raido-openapi-generated-node` | Auto-generated Node.js client for communicating with the external Raido API. Generated via OpenAPI tools. |
| `redbox-hook-kit` | `@researchdatabox/redbox-hook-kit` | TypeScript development toolkit for creating ReDBox hooks. See [Redbox Hook Kit](Redbox-Hook-Kit). |

## Pre-Lift Shim Generation

Before Sails.js lifts, the `redbox-loader.js` module generates shim files to bridge Sails.js to the core types package. This eliminates race conditions with hook loading order.

```
Application Start
    │
    ▼
redbox-loader.generateAllShims()
    ├── Scans dependencies for hook registrations
    ├── Generates api/models/*.js shims from WaterlineModels
    ├── Generates api/services/*.js shims from ServiceExports
    ├── Generates api/policies/*.js shims from Policies
    ├── Generates api/middleware/*.js shims
    ├── Generates api/responses/*.js shims
    ├── Generates config/*.js shims from Config defaults
    └── Generates config/bootstrap.js orchestrating startup
    │
    ▼
sails.lift()
    └── Sails loads generated shim files and bootstraps
```

See [Redbox Loader](Redbox-Loader) for detailed documentation.

## Frontend Architecture (`angular/`)

The frontend is a modern Angular application located in the `angular/` directory.

- **Workspace**: It is structured as an Angular CLI workspace.
- **Projects**: Contains the main application and potential libraries in `angular/projects/`.
- **State Management**: Uses **NgRx** (`@ngrx/store`, `@ngrx/effects`) for reactive state management.
- **Forms**: Utilizes **Formly** (`@ngx-formly/core`) for dynamic form generation.
- **UI Framework**: Built with **Bootstrap** and `ngx-bootstrap`.
- **Dependencies**: Depends on local `sails-ng-common` for shared data models.

## Root Project Role

The root directory acts as the **Sails.js Application Host** and the **Monorepo Orchestrator**.

- **Sails.js Host**: It contains the `api/` directory (Controllers, Policies) and `config/` that define the running server.
- **Orchestrator**: The root `package.json` contains scripts to:
    - Compile all local packages (`npm run compile:all`).
    - Build the Angular frontend (`npm run compile:ng`).
    - Run the development environment via Docker (`npm run dev:run`).
    - Execute tests (`npm run test:*`).

## Data Flow

1. **Client Request**: Incoming HTTP requests are handled by Sails.js (Express-based).
2. **Authentication**: Passport.js handles authentication (Local, JWT, OIDC).
3. **Controllers**: `api/controllers` handle request routing and response formatting.
4. **Services**: Business logic is encapsulated in core services (e.g., `RecordsService`, `UsersService`, `FormsService`). Services are loaded via shims from `@researchdatabox/redbox-core-types`.
5. **Persistence**: Data is stored in MongoDB using Waterline ORM models defined in `api/models`.

## Services Architecture

All business logic is centralized in the `@researchdatabox/redbox-core-types` package. Services follow a consistent pattern:

- Extend `Services.Core.Service` base class
- Declare exported methods via `_exportedMethods` array
- Use RxJS Observables for async operations
- Access Sails globals (`sails.config`, models) at runtime

### Service Categories

| Category | Services |
|---|---|
| **Records & Data** | RecordsService, RecordTypesService, FormsService |
| **Workflows** | WorkflowStepsService, TriggerService |
| **Users & Auth** | UsersService, RolesService |
| **Search** | SolrSearchService, NamedQueryService |
| **Integrations** | OrcidService, DoiService, FigshareService, RaidService |
| **Configuration** | ConfigService, AppConfigService, BrandingService |

See [Redbox Core Types - Services](Redbox-Core-Types#core-services) for complete documentation.

## Build System

- **Backend**: TypeScript is compiled using `tsc`.
- **Frontend**: Webpack builds the Angular application.
- **Docker**: Dockerfiles define runtime and test environments.

See `package.json` `scripts` for build commands (e.g., `npm run compile:all`).

