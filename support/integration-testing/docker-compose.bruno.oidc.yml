networks:
  main:

x-bruno-service: &bruno-service
  image: node:24-bullseye
  pull_policy: 'missing'
  volumes:
    - "../../.tmp/junit/backend-bruno:/opt/junit/backend-bruno"
    - "../../test/bruno/bruno.json:/opt/bruno-tests/bruno.json"
    - "../../test/bruno/package.json:/opt/bruno-tests/package.json"
    - "../../test/bruno/package-lock.json:/opt/bruno-tests/package-lock.json"
    - "../../test/bruno/attachment.png:/opt/bruno-tests/attachment.png"
    - "../../test/bruno/environments:/opt/bruno-tests/environments"
    - "../../test/bruno/5 - OpenID Connect Denied:/opt/bruno-tests/5 - OpenID Connect Denied"
    - "../../test/bruno/6 - OpenID Connect Allowed:/opt/bruno-tests/6 - OpenID Connect Allowed"
    - "../../test/bruno/bruno-helpers.js:/opt/bruno-tests/bruno-helpers.js"
    - "../../support/integration-testing/run-bruno-oidc.sh:/opt/bruno-tests/run-bruno-oidc.sh"
    - "../../test/bruno/validate-bruno-files.js:/opt/bruno-tests/validate-bruno-files.js"
    - "../../.tmp/junit/backend-bruno:/opt/junit/backend-bruno"
  working_dir: /opt/bruno-tests
  stop_grace_period: 30m
  networks:
    main:
      aliases:
        - bruno
  init: true
  entrypoint:
    - bash
    - /opt/bruno-tests/run-bruno-oidc.sh

x-rbportal-env: &rbportal-env
  - NODE_ENV=integrationtest
  - PORT=1500
  - NODE_OPTIONS=--max-old-space-size=1024
  - "RBPORTAL_REMOTE_DEBUG=${RBPORTAL_REMOTE_DEBUG:-}"
  - sails_redbox__apiKey=c8e844fc-8550-497f-b970-7900ec8741ca
  - sails_record__baseUrl_redbox=http://redbox:9000/redbox
  - sails_record__baseUrl_mint=http://203.101.226.160/mint
  # - sails_log__level=verbose
  - sails_brandingConfigurationDefaults__auth__local__default__token=d077835a-696b-4728-85cf-3ffd57152b1e
  - sails_security__csrf=false
  - "BRUNO_POST_SLEEP_SECONDS=${BRUNO_POST_SLEEP_SECONDS:-30}"

x-rbportal-depends: &rbportal-depends
  keycloak:
    condition: 'service_healthy'
  mongodb:
    condition: 'service_healthy'
  solr:
    condition: 'service_healthy'
  email:
    condition: 'service_healthy'

x-rbportal-service: &rbportal-service
  image: ${RBPORTAL_IMAGE:-qcifengineering/redbox-portal:develop}
  pull_policy: 'never'
  user: root
  # Debugging port (publish only when debugging locally)
  # ports:
  #   - "9876:9876"
  volumes:
    - "../../test:/opt/redbox-portal/test"
    - "../../support:/opt/redbox-portal/support"
    - "../../coverage/bruno-oidc:/opt/redbox-portal/coverage/bruno-oidc"
    - "../../app.integrationtest.js:/opt/redbox-portal/app.integrationtest.js"
    - "../../.tmp/attachments:/attachments"
    - "../../test/resources/config/emailnotification.js:/opt/redbox-portal/config/emailnotification.js"
    - "../resources/development/bootstrap-data:/opt/redbox-portal/bootstrap-data:ro"
  stop_grace_period: 30m
  healthcheck:
    test: ["CMD-SHELL", "curl http://localhost:1500/default/rdmp/home"]
    interval: '10s'
    timeout: '5s'
    retries: 10
    start_period: '600s'
  depends_on: *rbportal-depends
  expose:
    - "1500"
    - "1599"
  environment: *rbportal-env
  networks:
    main:
      aliases:
        - redboxportal
  # add 'node --inspect=0.0.0.0:9876' for debugging locally
  init: true
  entrypoint:
    - bash
    - /opt/redbox-portal/support/integration-testing/run-bruno-oidc-redbox.sh

services:
  bruno:
    <<: *bruno-service
    profiles: [ci]
    depends_on:
      redboxportal:
        condition: service_healthy
  bruno-mount:
    <<: *bruno-service
    profiles: [mount]
    depends_on:
      redboxportal-mount:
        condition: service_healthy
  redboxportal:
    <<: *rbportal-service
    profiles: [ci]
  redboxportal-mount:
    <<: *rbportal-service
    profiles: [mount]
    image: ${RBPORTAL_IMAGE:-qcifengineering/redbox-portal:develop}
    volumes:
      - "../../:/opt/redbox-portal:delegated"
      - "../../.tmp/attachments:/attachments"
      - "../../test/resources/config/emailnotification.js:/opt/redbox-portal/config/emailnotification.js"
      - "../resources/development/bootstrap-data:/opt/redbox-portal/bootstrap-data:ro"
  mongodb:
    image: mongo:latest
    pull_policy: 'missing'
    networks:
      main:
        aliases:
          - mongodb
    # No published ports needed in CI
    healthcheck:
      test: [ 'CMD-SHELL', "echo 'db.runCommand(\"ping\").ok' | mongosh" ]
      interval: '10s'
      timeout: '5s'
      retries: 10
      start_period: '30s'
  solr:
    image: solr:latest
    pull_policy: 'missing'
    expose:
      - "8983"
    # No published ports needed in CI
    healthcheck:
      test: [ 'CMD-SHELL', 'curl http://localhost:8983' ]
      interval: '10s'
      timeout: '5s'
      retries: 10
      start_period: '30s'
    networks:
      main:
       aliases:
         - solr
    entrypoint:
      - docker-entrypoint.sh
      - solr-precreate
      - redbox
  keycloak:
    image: quay.io/keycloak/keycloak:17.0.1
    pull_policy: 'missing'
    expose:
      - "8080"
    # No published ports needed in CI
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:8080"]
      interval: '10s'
      timeout: '5s'
      retries: 10
      start_period: '30s'
    volumes:
      - "./keycloakdb/data:/opt/keycloak/data"
    networks:
      main:
       aliases:
         - keycloak
    command:
      - start-dev
  email:
    image: axllent/mailpit:latest
    pull_policy: 'missing'
    expose:
      - '1025'
      - '8025'
    # No published ports needed in CI
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: '/data/mailpit.db'
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
      TZ: 'Australia/Brisbane'
    volumes:
      - '../../.tmp/email:/data'
    networks:
      main:
        aliases:
          - 'email'
