jobs:
  build:
    docker:
      - image: 'cimg/node:24.2.0'
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker
      - restore_cache:
          keys:
            - v1-buildx-cache-{{ .Branch }}-
            - v1-buildx-cache-
      - run:
          name: Build runtime image via Dockerfile
          command: |
            mkdir -p /tmp/.buildx-cache
            if docker buildx inspect portal-builder >/dev/null 2>&1; then
              docker buildx use portal-builder
            else
              docker buildx create --name portal-builder --driver docker-container --use
            fi
            docker buildx build \
              --progress plain \
              --target runtime \
              --cache-from type=local,src=/tmp/.buildx-cache \
              --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
              --load \
              -t redbox-portal:test .
            if [ -d /tmp/.buildx-cache-new ]; then
              rm -rf /tmp/.buildx-cache
              mv /tmp/.buildx-cache-new /tmp/.buildx-cache
            fi
      - save_cache:
          key: v1-buildx-cache-{{ .Branch }}-{{ .Revision }}
          paths:
            - /tmp/.buildx-cache
  test-bruno-general:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/junit/backend-bruno
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Bruno General tests
          no_output_timeout: 30m
          command: BRUNO_POST_SLEEP_SECONDS=180 timeout 1800s npm run test:bruno:general
      - run:
          name: Clean up Bruno containers
          command: npm run test:bruno:clean || true
          when: always
      - run:
          name: Upload Bruno General code coverage
          command: |
             /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
              --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
              --flag "backend-bruno-general" --file "./coverage/bruno-general/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-bruno-oidc:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/junit/backend-bruno
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Bruno OIDC tests
          no_output_timeout: 30m
          command: BRUNO_POST_SLEEP_SECONDS=180 timeout 1800s npm run test:bruno:oidc
      - run:
          name: Clean up Bruno containers
          command: npm run test:bruno:clean || true
          when: always
      - run:
          name: Upload Bruno OIDC code coverage
          command: |
             /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
              --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
              --flag "backend-bruno-oidc" --file "./coverage/bruno-oidc/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-mocha:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/junit/backend-mocha
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Mocha tests
          no_output_timeout: 30m
          command: timeout 1800s npm run test:mocha
      - run:
          name: Upload Mocha code coverage
          command: |
             /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
              --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
              --flag "backend-mocha" --file "./coverage/mocha/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-angular:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Compile shared Angular packages
          command: npm run compile:sails-ng-common:prod && source support/build/compileProductionAngular.sh portal-ng-common && source support/build/compileProductionAngular.sh portal-ng-form-custom
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Angular tests
          no_output_timeout: 30m
          command: |
            chmod +x support/unit-testing/angular/testAngular.sh
            source support/unit-testing/angular/testAngular.sh
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  deploy:
    docker:
      - image: 'cimg/node:24.2.0'
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build docker container
          command: |
            chmod +x dockerhub_deploy.sh
            ./dockerhub_deploy.sh
      - run:
          name: Upload container to Nexus
          command: |
            echo $CIRCLE_BRANCH
            npm pack
            PACKAGE_VERSION=$(cat package.json \
            | grep version \
            | head -1 \
            | awk -F: '{ print $2 }' \
            | sed 's/[", \t]//g')
            RBPORTAL_FILENAME=$(ls redbox-portal-*.tgz)
            curl -v -u $MAVEN_USER:$MAVEN_PASSWORD --upload-file $RBPORTAL_FILENAME "https://nexus-prod.redboxresearchdata.com.au/nexus/repository/maven-snapshots/au/edu/qcif/redbox-portal/${PACKAGE_VERSION}-SNAPSHOT/redbox-portal-${PACKAGE_VERSION}-SNAPSHOT.tgz"  
  generate-docs:
    machine:
      image: ubuntu-2004:current
    steps:
      - add_ssh_keys:
          fingerprints:
            - "50:0c:a1:7f:b6:64:84:42:01:61:0f:76:3f:e4:78:ff"
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Generate angular docs
          command: npm run doc-ng2
      - run:
          name: Deploy docs by adding commit to gh-pages branch
          command: |
            npm install -g --silent gh-pages@2.0.1
            git config user.email "ci-build@redboxresearchdata.com.au"
            git config user.name "ci-build"
            gh-pages --dotfiles --message "[ci skip] Updating documents" --dist support/docs/generated/ng2
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
orbs:
  node: circleci/node@4.0.0
  docker: circleci/docker@1.4.0
version: 2.1
workflows:
  build_test_gendocs_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              ignore: /^dependabot.*/
      - test-bruno-general:
          requires:
            - build
      - test-bruno-oidc:
          requires:
            - build
      - test-mocha:
          requires:
            - build
      - test-angular:
          requires:
            - build
      - deploy:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
          filters:
            branches:
              ignore: /^dependabot.*/
      - generate-docs:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
          filters:
            branches:
              only: 'master'
  build_test_dependabot:
    jobs:
      - build:
          filters:
            branches:
              only: /^dependabot.*/
            tags:
              ignore: /.*/
      - test-bruno-general:
          requires:
            - build
      - test-bruno-oidc:
          requires:
            - build
      - test-mocha:
          requires:
            - build
      - test-angular:
          requires:
            - build
      - deploy:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
          filters:
            branches:
              ignore: /^dependabot.*/
      - generate-docs:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
          filters:
            branches:
              only: 'master'
  release_build_test_gendocs_and_deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-bruno-general:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-bruno-oidc:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-mocha:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-angular:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
