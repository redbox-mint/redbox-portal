jobs:
  build:
    docker:
      - image: 'cimg/node:24.11.1'
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build runtime image via Dockerfile
          command: |
            docker build \
              --progress plain \
              --target runtime \
              --tag redbox-portal:test \
              .
      - run:
          name: Save Docker image
          command: |
            mkdir -p /tmp/docker-images
            docker save -o /tmp/docker-images/redbox-portal-test.tar redbox-portal:test
      - persist_to_workspace:
          root: /tmp
          paths:
            - docker-images/redbox-portal-test.tar
  build-runtime-datastream-cloud:
    docker:
      - image: 'cimg/node:24.11.1'
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build runtime_datastream_cloud image via Dockerfile
          command: |
            docker build \
              --progress plain \
              --target runtime_datastream_cloud \
              --tag redbox-portal:runtime-datastream-cloud-test \
              .
      - run:
          name: Save Docker image
          command: |
            mkdir -p /tmp/docker-images
            docker save -o /tmp/docker-images/redbox-portal-runtime-datastream-cloud-test.tar redbox-portal:runtime-datastream-cloud-test
      - persist_to_workspace:
          root: /tmp
          paths:
            - docker-images/redbox-portal-runtime-datastream-cloud-test.tar
  build-runtime-pdfgen:
    docker:
      - image: 'cimg/node:24.11.1'
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build runtime_pdfgen image via Dockerfile
          command: |
            docker build \
              --progress plain \
              --target runtime_pdfgen \
              --tag redbox-portal:runtime-pdfgen-test \
              .
      - run:
          name: Save Docker image
          command: |
            mkdir -p /tmp/docker-images
            docker save -o /tmp/docker-images/redbox-portal-runtime-pdfgen-test.tar redbox-portal:runtime-pdfgen-test
      - persist_to_workspace:
          root: /tmp
          paths:
            - docker-images/redbox-portal-runtime-pdfgen-test.tar
  build-runtime-cloud-pdfgen:
    docker:
      - image: 'cimg/node:24.11.1'
    resource_class: large
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build runtime_cloud_pdfgen image via Dockerfile
          command: |
            docker build \
              --progress plain \
              --target runtime_cloud_pdfgen \
              --tag redbox-portal:runtime-cloud-pdfgen-test \
              .
      - run:
          name: Save Docker image
          command: |
            mkdir -p /tmp/docker-images
            docker save -o /tmp/docker-images/redbox-portal-runtime-cloud-pdfgen-test.tar redbox-portal:runtime-cloud-pdfgen-test
      - persist_to_workspace:
          root: /tmp
          paths:
            - docker-images/redbox-portal-runtime-cloud-pdfgen-test.tar
  test-bruno-general:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    environment:
      RBPORTAL_IMAGE: redbox-portal:test
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Load Docker image
          command: docker load -i /tmp/docker-images/redbox-portal-test.tar
      - run:
          name: Point compose at tested image
          command: echo 'export RBPORTAL_IMAGE=redbox-portal:test' >> "$BASH_ENV"
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/junit/backend-bruno
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Bruno General tests
          no_output_timeout: 30m
          command: BRUNO_POST_SLEEP_SECONDS=180 timeout 1800s npm run test:bruno:general:ci
      - run:
          name: Clean up Bruno containers
          command: npm run test:bruno:clean || true
          when: always
      - run:
          name: Upload Bruno General code coverage
          command: |
            /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
             --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
             --flag "backend-bruno-general" --file "./coverage/bruno-general/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-bruno-oidc:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    environment:
      RBPORTAL_IMAGE: redbox-portal:test
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Load Docker image
          command: docker load -i /tmp/docker-images/redbox-portal-test.tar
      - run:
          name: Point compose at tested image
          command: echo 'export RBPORTAL_IMAGE=redbox-portal:test' >> "$BASH_ENV"
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/junit/backend-bruno
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Bruno OIDC tests
          no_output_timeout: 30m
          command: BRUNO_POST_SLEEP_SECONDS=180 timeout 1800s npm run test:bruno:oidc:ci
      - run:
          name: Clean up Bruno containers
          command: npm run test:bruno:clean || true
          when: always
      - run:
          name: Upload Bruno OIDC code coverage
          command: |
            /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
             --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
             --flag "backend-bruno-oidc" --file "./coverage/bruno-oidc/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-mocha:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    environment:
      RBPORTAL_IMAGE: redbox-portal:test
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Load Docker image
          command: docker load -i /tmp/docker-images/redbox-portal-test.tar
      - run:
          name: Point compose at tested image
          command: echo 'export RBPORTAL_IMAGE=redbox-portal:test' >> "$BASH_ENV"
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Install required ReDBox dependencies
          command: |
            npm run compile:sails-ng-common && npm run compile:raido && npm run compile:rva && npm run compile:core && npm run compile:storage-mongo && npm run compile:sails
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/junit/backend-mocha
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Mocha tests
          no_output_timeout: 30m
          command: timeout 1800s npm run test:mocha:ci
      - run:
          name: Upload Mocha code coverage
          command: |
            /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
             --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
             --flag "backend-mocha" --file "./coverage/mocha/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-angular:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Compile shared Angular packages
          command: >-
            npm run compile:sails-ng-common:prod
            && source support/build/compileProductionAngular.sh portal-ng-common
            && cd .. && source support/build/compileProductionAngular.sh portal-ng-form-custom
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Setup test directories
          command: |
            sudo mkdir -p .tmp/attachments/staging
            sudo chmod -R 777 .
      - run:
          name: Run Angular tests
          no_output_timeout: 30m
          command: |
            chmod +x support/unit-testing/angular/testAngular.sh
            source support/unit-testing/angular/testAngular.sh
      - store_test_results:
          path: .tmp/junit
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
  test-sails-ng-common:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Install packages
          command: |
            npm install --no-save --ignore-scripts
            cd ./packages/sails-ng-common
            npm ci --include=dev
      - run:
          name: Run Mocha tests
          no_output_timeout: 30m
          command: |
            cd ./packages/sails-ng-common
            npm run pretest
            npx nyc --no-clean --report-dir ./coverage/sails-ng-common --reporter=lcov --exclude-after-remap=false \
              npx mocha --config test/unit/.mocharc.js --exit dist/test/unit/**/*.test.js
      - run:
          name: Upload Mocha code coverage
          command: |
            cd ./packages/sails-ng-common
            /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
             --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
             --flag "backend-sails-ng-common" --file "./coverage/sails-ng-common/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: packages/sails-ng-common/support/junit
  test-redbox-core-types:
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Install required ReDBox dependencies
          command: |
            npm install --no-save --ignore-scripts && npm run compile:sails-ng-common && npm run compile:raido && npm run compile:rva
      - run:
          name: Install packages
          command: |
            cd ./packages/redbox-core-types
            npm ci --include=dev
      - run:
          name: Run Mocha tests with coverage
          no_output_timeout: 30m
          command: |
            cd ./packages/redbox-core-types
            mkdir -p support/junit
            nvm install && npx nyc --no-clean --report-dir ./coverage/redbox-core-types --reporter=lcov --exclude-after-remap=false \
              npx mocha --config .mocharc.js --exit test/**/*.test.ts
      - run:
          name: Upload redbox-core-types code coverage
          command: |
            cd ./packages/redbox-core-types
            /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
             --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
             --flag "backend-redbox-core-types" --file "./coverage/redbox-core-types/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
      - store_test_results:
          path: packages/redbox-core-types/support/junit
  test-redbox-hook-kit-cli:
    machine:
      image: ubuntu-2004:current
    resource_class: medium
    steps:
      - checkout
      - run:
          name: Install codecov
          command: |
            mkdir -p /tmp/.codecov-cli
            cd /tmp/.codecov-cli
            curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
            curl -Os https://cli.codecov.io/latest/linux/codecov
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
            curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
            gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
            shasum -a 256 -c codecov.SHA256SUM
            chmod +x codecov
      - run:
          name: Install root dependencies
          command: |
            npm install --no-save --ignore-scripts
      - run:
          name: Compile shared packages
          command: |
            npm run compile:raido && npm run compile:rva && npm run compile:core
      - run:
          name: Compile sails-ng-common
          command: |
            npm run compile:sails-ng-common
      - run:
          name: Install redbox-hook-kit dependencies
          command: |
            cd ./packages/redbox-hook-kit
            npm ci --include=dev
      - run:
          name: Run hook-kit CLI tests with coverage
          no_output_timeout: 30m
          command: |
            cd ./packages/redbox-hook-kit
            mkdir -p coverage/redbox-hook-kit
            TS_NODE_PROJECT=test/tsconfig.json ../../node_modules/.bin/nyc --no-clean --report-dir ./coverage/redbox-hook-kit --reporter=lcov --exclude-after-remap=false \
              ./node_modules/.bin/mocha --require ts-node/register --extension ts --exit test/**/*.test.ts
      - run:
          name: Upload redbox-hook-kit CLI code coverage
          command: |
            cd ./packages/redbox-hook-kit
            /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
             --token "${CODECOV_TOKEN}" --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
             --flag "backend-redbox-hook-kit-cli" --file "./coverage/redbox-hook-kit/lcov.info" --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
          when: always
  lint-redbox-core-types:
    docker:
      - image: 'cimg/node:24.11.1'
    resource_class: medium
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install redbox-core-types dependencies
          command: |
            cd ./packages/redbox-core-types
            npm ci --include=dev
      - run:
          name: Run lint for redbox-core-types
          command: |
            cd ./packages/redbox-core-types
            npm run lint
  # test-sails-hook-redbox-storage-mongo:
  #   machine:
  #     image: ubuntu-2004:current
  #   resource_class: medium
  #   environment:
  #     BUILDKIT_PROGRESS: 'plain'
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: /tmp
  #     - run:
  #         name: Install codecov
  #         command: |
  #           mkdir -p /tmp/.codecov-cli
  #           cd /tmp/.codecov-cli
  #           curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
  #           curl -Os https://cli.codecov.io/latest/linux/codecov
  #           curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM
  #           curl -Os https://cli.codecov.io/latest/linux/codecov.SHA256SUM.sig
  #           gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
  #           shasum -a 256 -c codecov.SHA256SUM
  #           chmod +x codecov
  #     - run:
  #         name: Install required ReDBox dependencies
  #         command: |
  #           npm run compile:sails-ng-common && npm run compile:raido && npm run compile:core
  #     - run:
  #         name: Install packages
  #         command: |
  #           cd ./packages/sails-hook-redbox-storage-mongo
  #           npm ci --strict-peer-deps --ignore-scripts
  #           node_modules/.bin/tsc
  #     - run:
  #         # TODO: chmod 777 isn't great, but the permission errors were getting too complicated
  #         name: Run Mocha tests
  #         no_output_timeout: 30m
  #         command: |
  #           cd ./packages/sails-hook-redbox-storage-mongo
  #           mkdir -p support/junit
  #           sudo chmod -R 'u=rwx,g=rwx,o=rwx' .
  #           npm run test:clean
  #           npm test
  #     - run:
  #         name: Upload Mocha code coverage
  #         command: |
  #           cd ./packages/sails-hook-redbox-storage-mongo
  #           /tmp/.codecov-cli/codecov --verbose upload-process --fail-on-error --disable-search \
  #           --token "${CODECOV_TOKEN}" \
  #           --name "job-${CIRCLE_BUILD_NUM}-${CIRCLE_TAG:-$CIRCLE_BRANCH}" \
  #           --flag "backend-sails-hook-redbox-storage-mongo" \
  #           --file "./coverage/mocha/lcov.info" \
  #           --branch "${CIRCLE_TAG:-$CIRCLE_BRANCH}"
  #         when: always
  #     - store_test_results:
  #         path: packages/sails-hook-redbox-storage-mongo/support/junit
  deploy:
    docker:
      - image: 'cimg/node:24.11.1'
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /tmp
      - run:
          name: Load and tag tested Docker image
          command: |
            docker load -i /tmp/docker-images/redbox-portal-test.tar
            echo "${DOCKER_PASS}" | docker login --username "${DOCKER_USER}" --password-stdin

            # Determine the tag
            if [[ -n "${CIRCLE_BRANCH:-}" ]]; then
              export TAG="$CIRCLE_BRANCH"
            elif [[ -n "${CIRCLE_TAG:-}" ]]; then
              export TAG="$CIRCLE_TAG"
            else
              export TAG="local"
            fi
            export DEPLOY_TAG=${TAG//\//-}
            export REPO=${REPO:-qcifengineering/redbox-portal}
            # Tag and push the tested amd64 image
            docker tag redbox-portal:test "${REPO}:${DEPLOY_TAG}-amd64"
            docker push "${REPO}:${DEPLOY_TAG}-amd64"
      - run:
          name: Upload container to Nexus
          command: |
            echo $CIRCLE_BRANCH
            npm pack
            PACKAGE_VERSION=$(cat package.json \
            | grep version \
            | head -1 \
            | awk -F: '{ print $2 }' \
            | sed 's/[", \t]//g')
            RBPORTAL_FILENAME=$(ls redbox-portal-*.tgz)
            curl -v -u $MAVEN_USER:$MAVEN_PASSWORD --upload-file $RBPORTAL_FILENAME "https://nexus-prod.redboxresearchdata.com.au/nexus/repository/maven-snapshots/au/edu/qcif/redbox-portal/${PACKAGE_VERSION}-SNAPSHOT/redbox-portal-${PACKAGE_VERSION}-SNAPSHOT.tgz"
  deploy-runtime-datastream-cloud:
    docker:
      - image: 'cimg/node:24.11.1'
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /tmp
      - run:
          name: Load and push datastream cloud image
          command: |
            docker load -i /tmp/docker-images/redbox-portal-runtime-datastream-cloud-test.tar
            echo "${DOCKER_PASS}" | docker login --username "${DOCKER_USER}" --password-stdin

            if [[ -n "${CIRCLE_BRANCH:-}" ]]; then
              export TAG="$CIRCLE_BRANCH"
            elif [[ -n "${CIRCLE_TAG:-}" ]]; then
              export TAG="$CIRCLE_TAG"
            else
              export TAG="local"
            fi
            export DEPLOY_TAG=${TAG//\//-}
            export REPO=${REPO:-qcifengineering/redbox-portal}

            docker tag redbox-portal:runtime-datastream-cloud-test "${REPO}:${DEPLOY_TAG}-datastream-cloud-amd64"
            docker push "${REPO}:${DEPLOY_TAG}-datastream-cloud-amd64"
  deploy-runtime-pdfgen:
    docker:
      - image: 'cimg/node:24.11.1'
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /tmp
      - run:
          name: Load and push pdfgen image
          command: |
            docker load -i /tmp/docker-images/redbox-portal-runtime-pdfgen-test.tar
            echo "${DOCKER_PASS}" | docker login --username "${DOCKER_USER}" --password-stdin

            if [[ -n "${CIRCLE_BRANCH:-}" ]]; then
              export TAG="$CIRCLE_BRANCH"
            elif [[ -n "${CIRCLE_TAG:-}" ]]; then
              export TAG="$CIRCLE_TAG"
            else
              export TAG="local"
            fi
            export DEPLOY_TAG=${TAG//\//-}
            export REPO=${REPO:-qcifengineering/redbox-portal}

            docker tag redbox-portal:runtime-pdfgen-test "${REPO}:${DEPLOY_TAG}-pdfgen-amd64"
            docker push "${REPO}:${DEPLOY_TAG}-pdfgen-amd64"
  deploy-runtime-cloud-pdfgen:
    docker:
      - image: 'cimg/node:24.11.1'
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /tmp
      - run:
          name: Load and push datastream cloud + pdfgen image
          command: |
            docker load -i /tmp/docker-images/redbox-portal-runtime-cloud-pdfgen-test.tar
            echo "${DOCKER_PASS}" | docker login --username "${DOCKER_USER}" --password-stdin

            if [[ -n "${CIRCLE_BRANCH:-}" ]]; then
              export TAG="$CIRCLE_BRANCH"
            elif [[ -n "${CIRCLE_TAG:-}" ]]; then
              export TAG="$CIRCLE_TAG"
            else
              export TAG="local"
            fi
            export DEPLOY_TAG=${TAG//\//-}
            export REPO=${REPO:-qcifengineering/redbox-portal}

            docker tag redbox-portal:runtime-cloud-pdfgen-test "${REPO}:${DEPLOY_TAG}-cloud-pdfgen-amd64"
            docker push "${REPO}:${DEPLOY_TAG}-cloud-pdfgen-amd64"
  deploy-arm64:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    steps:
      - checkout
      - run:
          name: Build and push arm64 runtime image
          no_output_timeout: 30m
          command: |
            echo "${DOCKER_PASS}" | docker login --username "${DOCKER_USER}" --password-stdin
            # Determine the tag
            if [[ -n "${CIRCLE_BRANCH:-}" ]]; then
              export TAG="$CIRCLE_BRANCH"
            elif [[ -n "${CIRCLE_TAG:-}" ]]; then
              export TAG="$CIRCLE_TAG"
            else
              export TAG="local"
            fi
            export DEPLOY_TAG=${TAG//\//-}
            export REPO=${REPO:-qcifengineering/redbox-portal}
            docker build \
              --progress plain \
              --target runtime \
              --tag "${REPO}:${DEPLOY_TAG}-arm64" \
              .
            docker push "${REPO}:${DEPLOY_TAG}-arm64"
  publish-manifest:
    docker:
      - image: 'cimg/node:24.11.1'
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Create and push multi-arch manifest
          command: |
            echo "${DOCKER_PASS}" | docker login --username "${DOCKER_USER}" --password-stdin
            # Determine the tag
            if [[ -n "${CIRCLE_BRANCH:-}" ]]; then
              export TAG="$CIRCLE_BRANCH"
            elif [[ -n "${CIRCLE_TAG:-}" ]]; then
              export TAG="$CIRCLE_TAG"
            else
              export TAG="local"
            fi
            export DEPLOY_TAG=${TAG//\//-}
            export REPO=${REPO:-qcifengineering/redbox-portal}
            docker manifest create "${REPO}:${DEPLOY_TAG}" \
              "${REPO}:${DEPLOY_TAG}-amd64" \
              "${REPO}:${DEPLOY_TAG}-arm64"
            docker manifest push "${REPO}:${DEPLOY_TAG}"
  generate-docs:
    machine:
      image: ubuntu-2004:current
    steps:
      - add_ssh_keys:
          fingerprints:
            - '50:0c:a1:7f:b6:64:84:42:01:61:0f:76:3f:e4:78:ff'
      - checkout
      - restore_cache:
          keys:
            - v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - v1-npm-cache-{{ arch }}-{{ .Branch }}
            - v1-npm-cache-
      - run:
          name: Install npm dependencies
          command: npm ci
      - run:
          name: Generate angular docs
          command: npm run doc-ng2
      - run:
          name: Deploy docs by adding commit to gh-pages branch
          command: |
            npm install -g --silent gh-pages@2.0.1
            git config user.email "ci-build@redboxresearchdata.com.au"
            git config user.name "ci-build"
            gh-pages --dotfiles --message "[ci skip] Updating documents" --dist support/docs/generated/ng2
      - run:
          name: Publish wiki docs
          command: |
            git config user.email "ci-build@redboxresearchdata.com.au"
            git config user.name "ci-build"
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            tmp_dir=$(mktemp -d)
            git clone git@github.com:redbox-mint/redbox-portal.wiki.git "$tmp_dir"
            git -C "$tmp_dir" rm -r --ignore-unmatch .
            cp -a support/wiki/. "$tmp_dir"/
            cd "$tmp_dir"
            git add -A
            if git diff --cached --quiet; then
              echo "Wiki up to date; no changes to push."
            else
              git commit -m "[ci skip] Update wiki docs"
              branch=$(git symbolic-ref --short HEAD)
              git push origin "$branch"
            fi
      - save_cache:
          key: v1-npm-cache-{{ arch }}-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
orbs:
  node: circleci/node@4.0.0
  docker: circleci/docker@1.4.0
version: 2.1
workflows:
  build_test_gendocs_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              ignore: /^dependabot.*/
      - build-runtime-datastream-cloud:
          requires:
            - build
          filters:
            branches:
              ignore: /^dependabot.*/
      - build-runtime-pdfgen:
          requires:
            - build
          filters:
            branches:
              ignore: /^dependabot.*/
      - build-runtime-cloud-pdfgen:
          requires:
            - build
          filters:
            branches:
              ignore: /^dependabot.*/
      - test-bruno-general:
          requires:
            - build
      - test-bruno-oidc:
          requires:
            - build
      - test-mocha:
          requires:
            - build
      - test-angular:
          requires:
            - build
      - test-sails-ng-common:
          requires:
            - build
      # - lint-redbox-core-types:
      #     requires:
      #       - build
      - test-redbox-core-types:
          requires:
            - build
      - test-redbox-hook-kit-cli:
          requires:
            - build
      # - test-sails-hook-redbox-storage-mongo:
      #     requires:
      #       - build
      - deploy-arm64:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - deploy:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - deploy-runtime-datastream-cloud:
          requires:
            - build-runtime-datastream-cloud
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - deploy-runtime-pdfgen:
          requires:
            - build-runtime-pdfgen
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - deploy-runtime-cloud-pdfgen:
          requires:
            - build-runtime-cloud-pdfgen
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - publish-manifest:
          requires:
            - deploy
            - deploy-arm64
          filters:
            branches:
              ignore: /^dependabot.*/

      - generate-docs:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              only: 'master'
  build_test_dependabot:
    jobs:
      - build:
          filters:
            branches:
              only: /^dependabot.*/
            tags:
              ignore: /.*/
      - test-bruno-general:
          requires:
            - build
      - test-bruno-oidc:
          requires:
            - build
      - test-mocha:
          requires:
            - build
      - test-angular:
          requires:
            - build
      - test-sails-ng-common:
          requires:
            - build
      - test-redbox-core-types:
          requires:
            - build
      - test-redbox-hook-kit-cli:
          requires:
            - build
      # - test-sails-hook-redbox-storage-mongo:
      #     requires:
      #       - build
      - deploy-arm64:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - deploy:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              ignore: /^dependabot.*/
      - publish-manifest:
          requires:
            - deploy
            - deploy-arm64
          filters:
            branches:
              ignore: /^dependabot.*/
      - generate-docs:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            - test-redbox-hook-kit-cli
            # - test-sails-hook-redbox-storage-mongo
          filters:
            branches:
              only: 'master'
  release_build_test_gendocs_and_deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - build-runtime-datastream-cloud:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - build-runtime-pdfgen:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - build-runtime-cloud-pdfgen:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-bruno-general:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-bruno-oidc:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-mocha:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-angular:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-sails-ng-common:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - test-redbox-core-types:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      # - test-sails-hook-redbox-storage-mongo:
      #     requires:
      #       - build
      #     filters:
      #       tags:
      #         only: /^v.*/
      #       branches:
      #         ignore: /.*/
      - deploy-arm64:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            # - test-sails-hook-redbox-storage-mongo
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy:
          requires:
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            # - test-sails-hook-redbox-storage-mongo
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy-runtime-datastream-cloud:
          requires:
            - build-runtime-datastream-cloud
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            # - test-sails-hook-redbox-storage-mongo
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy-runtime-pdfgen:
          requires:
            - build-runtime-pdfgen
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            # - test-sails-hook-redbox-storage-mongo
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - deploy-runtime-cloud-pdfgen:
          requires:
            - build-runtime-cloud-pdfgen
            - test-bruno-general
            - test-bruno-oidc
            - test-mocha
            - test-angular
            - test-sails-ng-common
            - test-redbox-core-types
            # - test-sails-hook-redbox-storage-mongo
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - publish-manifest:
          requires:
            - deploy
            - deploy-arm64
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
