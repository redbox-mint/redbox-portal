meta {
  name: Keycloak login action
  type: http
  seq: 5
}

post {
  url: {{kc_login_url}}
  body: formUrlEncoded
  auth: none
}

headers {
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
  Accept-Language: en-US,en;q=0.9,en-AU;q=0.8,it;q=0.7
  Cache-Control: no-cache
  Connection: keep-alive
  Content-Type: application/x-www-form-urlencoded
  Origin: null
  Pragma: no-cache
  Upgrade-Insecure-Requests: 1
  User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.88 Safari/537.36
}

body:form-urlencoded {
  username: test-external
  password: password
  credentialId:
}

script:pre-request {
  req.setMaxRedirects(0);
  const newCookies = bru.getVar("kc_cookie") || [];
  const existingCookies = Object.hasOwn(req.headers, "Cookie") ? req.headers['Cookie'] : [];
  const cookies = [
    ...(Array.isArray(existingCookies) ? existingCookies : [existingCookies]),
    ...(Array.isArray(newCookies) ? newCookies : [newCookies]),
    ];
  if(cookies.length === 1) {
    req.headers['Cookie'] = cookies[0]
  } else if (cookies.length > 1){
    // See https://github.com/usebruno/bruno/issues/3475
    throw new Error(`Bruno does not support more than one cookie. Headers ${JSON.stringify(req.headers)} cookies ${JSON.stringify(cookies)}.`);
  }
}

tests {
  test("Status code is 302", function () {
      expect(res.getStatus()).to.equal(302);
      bru.setVar("rb_login_url", res.headers['location']);
      console.log(bru.getVar("rb_login_url"))
  });
}
